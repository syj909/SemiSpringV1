<!DOCTYPE html>
<html xmlns:th=http://www.thymeleaf.org>
<head>
<meta charset="UTF-8">
<title>세미프로젝트</title>
<link th:href="@{/static/css/base.css}" rel="stylesheet">
<style>
	/* 회원가입 폼에 대한 스타일 */
	#join { border: 1px solid blue;
		width: 300px; margin: 0 auto;}
	#join div { margin-bottom: 10px; }
	#join label { width: 110px; display: inline-block;
				text-align: right; font-weight: bold; padding: 3px; }
	#join input { padding: 3px; }
	#okbtn { margin-left: 100px; }
</style>
</head>
<body>
	<div id="container">
		<th:block th:include="layout/header"/>
	<div id="main">
		<h1>회원가입</h1>
		<form name="join" id="join">
			<div>
				<label for="uid">아이디</label>
				<input type="text" name="userid" id="uid">
				<span id="chkmsg"></span>
			</div>
			<div>
				<label for="pwd">비밀번호</label>
				<input type="password" name="passwd" id="pwd">
				<span id="pwdmsg"></span>
			</div>
			<div>
				<label for="rpw">비밀번호확인</label>
				<input type="password" name="repwd" id="rpw">
			</div>
			<div>
				<label for="name">이름</label>
				<input type="text" name="name" id="nm">
			</div>
			<div>
				<label for="eml">이메일</label>
				<input type="text" name="email" id="eml">
			</div>
			
			<div>
				<input type="hidden" name="chkuid" id="chkuid" value="no">
				<button type="button" id="okbtn">입력완료</button>
				<button type="reset">다시입력</button>
			</div>
		</form>
	</div>
		<th:block th:include="layout/footer"/>
	</div>
	
	<script>
		// 아이디 중복검사
		// /checkuid?uid=???를 이용해서 중복여부를 확인
		let userid = document.getElementById("uid");
		userid.addEventListener('blur', ()=>{
			let qry = '?uid=' + userid.value;
			let req = new XMLHttpRequest(); //1 ajax객체생성
			req.onreadystatechange = () =>{	//4 응답받은 후 처리
				if(req.readyState == XMLHttpRequest.DONE){
					if(req.status == 200){
						let text = req.response;
						checkuserid(text);	
					}
				}
			};
			req.open('get', '/checkuid' + qry); //2 서버 요청방식 정의
			req.send();							//3 서버 요청 보냄
			// ajax 호출
			// fetch('/checkuid' + qry).then(response => response.text()).then(text => checkuserid(text));
		})
	
		var okbtn = document.getElementById("okbtn");
		okbtn.addEventListener('click', checkjoinfrm);
		
		function checkjoinfrm(){
			var uid = document.getElementById("uid");
			var pwd = document.getElementById("pwd");
			var rpw = document.getElementById("rpw");
			var nm = document.getElementById("nm");
			var eml = document.getElementById("eml");
			var frm = document.join;
			
			if(uid.value == '') alert('아이디를 입력하세요.');
			else if(pwd.value == '') alert('비밀번호를 입력하세요.');
			else if(rpw.value != pwd.value) alert('비밀번호 확인을 하세요');
			else if(nm.value == '') alert('이름을 입력하세요.');
			else if(eml.value == '') alert('이메일을 입력하세요.');
			else if(frm.chkuid.value == 'no') alert('아이디 중복체크하세요.');
			else {
				frm.method = 'post';
				frm.submit();
			}
		}
		
		function checkuserid(result){
			let msg = document.getElementById('chkmsg');
			msg.style.marginLeft = 115 + 'px';
			if(result == '1') {
				msg.innerHTML = '사용불가아이디';
				msg.style.color = 'red';
				document.join.chkuid.value = 'no';
			} else if(result == '0') {
				msg.innerHTML = '사용가능아이디';
				msg.style.color = 'blue';
				document.join.chkuid.value = 'yes';
			}
		}
	</script>
</body>
</html>